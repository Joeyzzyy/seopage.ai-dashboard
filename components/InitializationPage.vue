<template>
  <div class="initialization-container">
    <!-- 修改：整合系统概览仪表盘 -->
    <div class="section-card dashboard-section">
      <a-spin :spinning="customerStatisticLoading || sseStatusLoading" tip="加载中...">
        <div class="dashboard-header">
          <div class="dashboard-title">
            <h3 class="title-text">系统概览仪表盘</h3>
            <span class="update-time">最后更新: {{ lastSSEUpdateTime }}</span>
          </div>
          <!-- 移动：将当前正在运行的任务数移到标题右侧 -->
          <div class="dashboard-header-right">
            <div class="running-tasks-indicator">
              <span class="task-label">当前正在运行的任务数： </span>
              <span class="task-count">{{ sseConnectionCount }}</span>
            </div>
          </div>
        </div>
        
        <div class="dashboard-content">
          <!-- 修改：客户转化漏斗统计 -->
          <div class="customer-stats-section">
            <div class="funnel-container">
              <div class="funnel-title">用户转化漏斗</div>
              
              <div class="funnel-steps">
                <!-- 第1层：总注册用户数 -->
                <div class="funnel-step step-1">
                  <div class="step-content">
                    <div class="step-info">
                      <span class="step-label">总注册用户数</span>
                      <span class="step-value">{{ totalRegistrations }}</span>
                    </div>
                    <!-- 新增：未跑过任务未订阅用户红色模块 -->
                    <div class="inactive-users-module">
                      <span class="inactive-label">未跑过任务未订阅</span>
                      <span class="inactive-value">{{ formatStatisticValue(customerStatisticData?.data?.unsubscribedNoTask) }}</span>
                      <span class="inactive-percentage">{{ calculatePercentage(customerStatisticData?.data?.unsubscribedNoTask, totalRegistrations) }}</span>
                    </div>
                  </div>
                  <div class="funnel-arrow"></div>
                </div>

                <!-- 第2层：有开启任务未订阅用户 -->
                <div class="funnel-step step-2">
                  <div class="step-content">
                    <div class="step-info">
                      <span class="step-label">有开启任务未订阅用户</span>
                      <span class="step-value">{{ formatStatisticValue(customerStatisticData?.data?.unsubscribeTaskOne) }}</span>
                      <span class="step-percentage">{{ calculatePercentage(customerStatisticData?.data?.unsubscribeTaskOne, totalRegistrations) }}</span>
                    </div>
                  </div>
                  <div class="funnel-arrow"></div>
                </div>

                <!-- 第3层：有部署页面未订阅用户 -->
                <div class="funnel-step step-3">
                  <div class="step-content">
                    <div class="step-info">
                      <span class="step-label">有部署页面未订阅用户</span>
                      <span class="step-value">{{ formatStatisticValue(customerStatisticData?.data?.unsubscribeDeployOne) }}</span>
                      <span class="step-percentage">{{ calculatePercentage(customerStatisticData?.data?.unsubscribeDeployOne, totalRegistrations) }}</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- 转化率总结 -->
              <div class="conversion-summary">
                <div class="summary-item">
                  <span class="summary-label">任务开启率：</span>
                  <span class="summary-value">{{ calculateConversionRate(customerStatisticData?.data?.unsubscribeTaskOne, totalRegistrations) }}</span>
                  <span class="summary-detail">{{ formatStatisticValue(customerStatisticData?.data?.unsubscribeTaskOne) }} / {{ formatStatisticValue(totalRegistrations) }}</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">页面部署转化率：</span>
                  <span class="summary-value">{{ calculateConversionRate(customerStatisticData?.data?.unsubscribeDeployOne, customerStatisticData?.data?.unsubscribeTaskOne) }}</span>
                  <span class="summary-detail">{{ formatStatisticValue(customerStatisticData?.data?.unsubscribeDeployOne) }} / {{ formatStatisticValue(customerStatisticData?.data?.unsubscribeTaskOne) }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </a-spin>
    </div>

    <!-- Error Monitoring Dashboard -->
    <a-card class="section-card">
      <div class="section-header">
        <div class="section-title-mobile">
          <span class="section-title">错误监控仪表盘</span>
        </div>
        <div class="header-actions-mobile">
           <a-select
             v-model:value="errorDashboardDays"
             class="mobile-select"
             :options="errorDashboardDateOptions"
             @change="handleErrorDashboardDateChange"
           >
             <template #suffixIcon><CalendarOutlined /></template>
           </a-select>
        </div>
      </div>
      <div v-if="errorDashboardLoading" class="loading-container">
        <a-spin tip="加载错误数据中..." />
      </div>
      <div v-else-if="errorDashboardData && errorDashboardData.length > 0">
        <v-chart
          :option="errorDashboardChartOption"
          autoresize
          class="mobile-chart"
        />
      </div>
      <div v-else class="empty-container">
        <a-empty :description="`最近 ${errorDashboardDays} 天内无错误数据`" />
      </div>
    </a-card>

    <!-- User Registration Trend -->
    <a-card class="section-card">
      <div class="section-header">
        <div class="title-and-summary-mobile">
          <span class="section-title">用户注册趋势</span>
          <!-- 移除：注册数汇总显示 -->
          <!-- 邀请码统计 - 移动端换行显示 -->
          <div class="invite-code-stats-mobile">
            <template v-for="(count, code) in inviteCodeStats" :key="code">
              <span class="invite-code-item">
                {{ code }}: {{ count }}
              </span>
            </template>
          </div>
        </div>
        <div class="header-actions-mobile">
          <a-select v-model:value="registerStatsDays" class="mobile-select" @change="updateRegisterChartData">
            <a-select-option :value="30">最近30天</a-select-option>
            <a-select-option :value="90">最近90天</a-select-option>
            <a-select-option :value="0">全部</a-select-option>
          </a-select>
        </div>
      </div>
      <v-chart
        :option="registerChartOption"
        autoresize
        class="mobile-chart"
      />
    </a-card>

    <!-- Customer Management -->
    <a-card class="section-card">
      <div class="section-header">
        <span class="section-title">客户管理</span>
        <!-- 移除包装容器，让筛选器直接占满宽度 -->
        <div class="filter-container">
          <div class="filter-header">
            <div class="filter-title-section">
              <span class="filter-title">
                <FilterOutlined />
                筛选条件
              </span>
              <!-- 搜索框移到筛选条件右侧 -->
              <div class="header-search-section">
                <a-input-search
                  v-model:value="searchEmail"
                  placeholder="搜索邮箱"
                  class="header-search-input"
                  @search="handleSearch"
                  @change="handleSearchChange"
                  allowClear
                  size="small"
                />
                <!-- 记录数量也移到这里 -->
                <div class="header-customer-stats">
                  <span class="stats-text">
                    共 <span class="stats-number">{{ pagination.total }}</span> 条
                  </span>
                  <span class="stats-text" v-if="pagination.total > 0">
                    第 <span class="stats-number">{{ pagination.current }}</span>/{{ Math.ceil(pagination.total / pagination.pageSize) }} 页
                  </span>
                </div>
              </div>
            </div>
            <div class="filter-header-actions">
              <a-button size="small" @click="clearFilters" :disabled="!hasActiveFilters">
                清空
              </a-button>
              <a-button 
                type="primary" 
                size="small" 
                @click="applyFilters"
                :loading="loading"
              >
                应用
              </a-button>
            </div>
          </div>
          
          <div class="filter-content">
            <!-- 新增：订阅状态筛选组 -->
            <div class="filter-group">
              <div class="filter-group-header">
                <div class="filter-group-title">订阅状态筛选</div>
              </div>
              <div class="filter-group-content">
                <a-radio-group v-model:value="subscribeFilter" @change="handleFilterChange">
                  <a-radio :value="true">仅显示未订阅用户</a-radio>
                  <a-radio :value="false">仅显示订阅用户</a-radio>
                </a-radio-group>
              </div>
            </div>

            <!-- 新增：域名绑定筛选组 -->
            <div class="filter-group">
              <div class="filter-group-header">
                <a-checkbox 
                  v-model:checked="domainBindFilter" 
                  @change="handleFilterChange"
                  class="filter-checkbox"
                >
                  <span class="filter-group-title">域名绑定筛选</span>
                </a-checkbox>
              </div>
              <div class="filter-group-content" :class="{ disabled: !domainBindFilter }">
                <div class="filter-description">
                  <span class="description-text">仅显示已完成域名绑定的用户</span>
                </div>
              </div>
            </div>

            <!-- 任务数量筛选组 -->
            <div class="filter-group">
              <div class="filter-group-header">
                <a-checkbox 
                  v-model:checked="enableWebsiteCountFilter" 
                  @change="handleFilterChange"
                  class="filter-checkbox"
                >
                  <span class="filter-group-title">任务数量筛选</span>
                </a-checkbox>
              </div>
              <div class="filter-group-content" :class="{ disabled: !enableWebsiteCountFilter }">
                <div class="range-inputs">
                  <a-input-number
                    v-model:value="minWebsiteCount"
                    :disabled="!enableWebsiteCountFilter"
                    placeholder="最小值"
                    :min="0"
                    class="range-input"
                    @change="handleFilterChange"
                  />
                  <span class="range-separator">至</span>
                  <a-input-number
                    v-model:value="maxWebsiteCount"
                    :disabled="!enableWebsiteCountFilter"
                    placeholder="最大值"
                    :min="0"
                    class="range-input"
                    @change="handleFilterChange"
                  />
                </div>
              </div>
            </div>

            <!-- 生成页面数筛选组 -->
            <div class="filter-group">
              <div class="filter-group-header">
                <a-checkbox 
                  v-model:checked="enableResultCountFilter" 
                  @change="handleFilterChange"
                  class="filter-checkbox"
                >
                  <span class="filter-group-title">生成页面数筛选</span>
                </a-checkbox>
              </div>
              <div class="filter-group-content" :class="{ disabled: !enableResultCountFilter }">
                <div class="range-inputs">
                  <a-input-number
                    v-model:value="minResultCount"
                    :disabled="!enableResultCountFilter"
                    placeholder="最小值"
                    :min="0"
                    class="range-input"
                    @change="handleFilterChange"
                  />
                  <span class="range-separator">至</span>
                  <a-input-number
                    v-model:value="maxResultCount"
                    :disabled="!enableResultCountFilter"
                    placeholder="最大值"
                    :min="0"
                    class="range-input"
                    @change="handleFilterChange"
                  />
                </div>
              </div>
            </div>

            <!-- 部署数量筛选组 -->
            <div class="filter-group">
              <div class="filter-group-header">
                <a-checkbox 
                  v-model:checked="enableDeployCountFilter" 
                  @change="handleFilterChange"
                  class="filter-checkbox"
                >
                  <span class="filter-group-title">部署数量筛选</span>
                </a-checkbox>
              </div>
              <div class="filter-group-content" :class="{ disabled: !enableDeployCountFilter }">
                <div class="range-inputs">
                  <a-input-number
                    v-model:value="minDeployCount"
                    :disabled="!enableDeployCountFilter"
                    placeholder="最小值"
                    :min="0"
                    class="range-input"
                    @change="handleFilterChange"
                  />
                  <span class="range-separator">至</span>
                  <a-input-number
                    v-model:value="maxDeployCount"
                    :disabled="!enableDeployCountFilter"
                    placeholder="最大值"
                    :min="0"
                    class="range-input"
                    @change="handleFilterChange"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 移动端使用卡片列表替代表格 -->
      <div class="mobile-customer-list" v-if="isMobile">
        <div v-if="loading" class="loading-container">
          <a-spin tip="加载客户数据中..." />
        </div>
        <div v-else>
          <div 
            v-for="customer in customers" 
            :key="customer.customerId"
            class="customer-card"
            :class="{ 'selected': customer.customerId === selectedCustomerId }"
            @click="handleCustomerSelect(customer)"
          >
            <div class="customer-header">
              <div class="customer-email">{{ customer.email }}</div>
              <div class="customer-status">
                <span v-if="customer.hasRecentErrors === true" class="error-indicator">
                  <WarningOutlined />
                  有错误
                </span>
                <span v-else-if="customer.hasRecentErrors === false" class="no-error-indicator">
                  正常
                </span>
              </div>
            </div>
            <div class="customer-details">
              <div class="detail-item">
                <span class="label">客户ID:</span>
                <span class="value">{{ customer.customerId }}</span>
              </div>
              <div class="detail-item">
                <span class="label">邀请码:</span>
                <span class="value">{{ customer.inviteCode || '-' }}</span>
              </div>
              <div class="detail-item">
                <span class="label">注册时间:</span>
                <span class="value">{{ customer.registerTime ? dayjs(customer.registerTime).format('YYYY-MM-DD HH:mm') : '-' }}</span>
              </div>
            </div>
            <div class="customer-actions">
              <a-button type="default" size="small" @click.stop="handleEditPlan(customer)">
                编辑计划
              </a-button>
              <a-button type="primary" size="small" @click.stop="handleLoginToAltpage(customer)">
                前往Altpage
              </a-button>
            </div>
          </div>
          
          <!-- 移动端分页 -->
          <div class="mobile-pagination">
            <a-pagination
              v-model:current="pagination.current"
              :total="pagination.total"
              :pageSize="pagination.pageSize"
              :showSizeChanger="false"
              :showQuickJumper="false"
              :showTotal="(total) => `共 ${total} 条`"
              @change="handleTableChange"
              size="small"
            />
          </div>
        </div>
      </div>
      
      <!-- 桌面端保持原有表格 -->
      <a-table
        v-else
        class="customer-table"
        :columns="initializationColumns"
        :data-source="customers"
        :pagination="pagination"
        :loading="loading"
        @change="handleTableChange"
        :row-class-name="getRowClassName"
        size="small"
        :customRow="customRowHandler"
        :scroll="{ x: 1500 }"
        rowKey="customerId"
      >
        <template #bodyCell="{ column, record }">
          <template v-if="column.key === 'action'">
            <a-space>
              <a-button type="default" size="small" @click.stop="handleEditPlan(record)">
                Edit Plan
              </a-button>
              <a-button type="primary" size="small" @click.stop="handleLoginToAltpage(record)">
                Goto Altpage
              </a-button>
            </a-space>
          </template>
          <template v-if="column.key === 'customerId'">
            <a-tooltip :title="record.customerId">
              <span>{{ record.customerId }}</span>
            </a-tooltip>
          </template>
          <template v-if="column.key === 'email'">
            <a-tooltip :title="record.email">
              <span>{{ record.email }}</span>
            </a-tooltip>
          </template>
          <template v-if="column.key === 'inviteCode'">
            <a-tooltip :title="record.inviteCode">
              <span>{{ record.inviteCode }}</span>
            </a-tooltip>
          </template>
        </template>
      </a-table>
    </a-card>

    <!-- Error Logs -->
    <a-card
      v-if="selectedCustomerId"
      class="section-card error-log-section"
    >
      <div class="section-header">
        <div class="section-title-mobile">
          <span class="section-title">{{ selectedCustomer?.email || '选中客户' }} 的错误日志</span>
        </div>
        <div class="header-actions-mobile">
           <a-select
             v-model:value="errorLogDays"
             class="mobile-select"
             :options="errorLogDateOptions"
             @change="handleErrorLogDateChange"
           >
             <template #suffixIcon><CalendarOutlined /></template>
           </a-select>
        </div>
      </div>
      
      <!-- 移动端错误日志列表 -->
      <div class="mobile-error-list" v-if="isMobile">
        <div v-if="errorLogLoading" class="loading-container">
          <a-spin tip="加载错误日志中..." />
        </div>
        <div v-else-if="errorLogs.length > 0">
          <div v-for="log in errorLogs" :key="log.id" class="error-log-card">
            <div class="error-header">
              <span class="error-time">{{ dayjs(log.createdAt).format('MM-DD HH:mm') }}</span>
              <span class="error-module">{{ log.module }}</span>
            </div>
            <div class="error-operation">{{ log.operation }}</div>
            <div class="error-website" v-if="log.websiteId">
              <span class="label">网站ID:</span>
              <span class="value">{{ log.websiteId }}</span>
            </div>
            <div class="error-detail">
              <a-typography-paragraph 
                :ellipsis="{ rows: 2, expandable: true, symbol: '展开' }"
                :content="log.errorDetail"
              />
            </div>
          </div>
          
          <!-- 移动端错误日志分页 -->
          <div class="mobile-pagination">
            <a-pagination
              v-model:current="errorLogPagination.current"
              :total="errorLogPagination.total"
              :pageSize="errorLogPagination.pageSize"
              :showSizeChanger="false"
              :showQuickJumper="false"
              :showTotal="(total) => `共 ${total} 条`"
              @change="handleErrorLogTableChange"
              size="small"
            />
          </div>
        </div>
        <div v-else class="empty-container">
          <a-empty :description="`选定时间段内无错误日志 (${errorLogDays} 天)`" />
        </div>
      </div>
      
      <!-- 桌面端保持原有表格 -->
      <a-table
        v-else
        :columns="errorLogColumns"
        :data-source="errorLogs"
        :pagination="errorLogPagination"
        :loading="errorLogLoading"
        @change="handleErrorLogTableChange"
        size="small"
        :scroll="{ x: 800 }"
        rowKey="id"
      >
        <template #emptyText>
          <a-empty :description="`No error logs found for the selected period (${errorLogDays} days).`" />
        </template>
        <template #bodyCell="{ column, text }">
            <template v-if="column.key === 'errorMessage'">
              <a-tooltip :title="text" placement="topLeft">
                <span>{{ text }}</span>
              </a-tooltip>
            </template>
          </template>
      </a-table>
    </a-card>

    <!-- Edit Package Modal -->
    <a-modal
      v-model:open="modalVisible"
      title="试用套餐详情"
      :footer="null"
      :width="isMobile ? '95%' : '600px'"
      :centered="isMobile"
    >
      <div v-if="selectedPackage" class="package-form">
        <a-form :model="selectedPackage" layout="vertical">
          <!-- Package Form Content -->
          <a-form-item label="Trial ID">
            <a-input v-model:value="selectedPackage.trialId" disabled />
          </a-form-item>
          <a-form-item label="Trial Name">
            <a-input v-model:value="selectedPackage.trialName" disabled />
          </a-form-item>
          <a-form-item label="Package ID">
            <a-input v-model:value="selectedPackage.packageId" disabled />
          </a-form-item>
          <a-form-item label="Customer ID">
            <a-input v-model:value="selectedPackage.customerId" disabled />
          </a-form-item>
          <a-form-item label="Status">
            <a-tag :color="selectedPackage.active ? 'green' : 'red'">
              {{ selectedPackage.active ? 'Active' : 'Inactive' }}
            </a-tag>
          </a-form-item>
          <a-form-item label="Start Time">
            <a-date-picker
              v-model:value="selectedPackage.startTime"
              :format="'YYYY-MM-DD'"
              style="width: 100%"
            />
          </a-form-item>
          <a-form-item label="End Time">
            <a-date-picker
              v-model:value="selectedPackage.endTime"
              :format="'YYYY-MM-DD'"
              style="width: 100%"
            />
          </a-form-item>
          <a-form-item label="Invite Code">
            <a-input v-model:value="selectedPackage.inviteCode" disabled />
          </a-form-item>
          <a-form-item label="Description">
            <a-textarea v-model:value="selectedPackage.description" disabled />
          </a-form-item>
          <a-form-item label="Duration (Days)">
            <a-input v-model:value="selectedPackage.duration" disabled />
          </a-form-item>
          <a-form-item label="Created At">
            <a-input v-model:value="selectedPackage.createdAt" disabled />
          </a-form-item>
          <a-form-item label="Package">
            <a-select
              v-model:value="selectedPackage.packageFeatureId"
              style="width: 100%"
              placeholder="Select package"
            >
              <a-select-option
                v-for="pkg in packageList"
                :key="pkg.packageFeatureId"
                :value="pkg.packageFeatureId"
              >
                {{ pkg.packageName }} (${{ pkg.packagePrice }})
              </a-select-option>
            </a-select>
          </a-form-item>
          <a-form-item>
            <a-button type="primary" :loading="saving" @click="handleSave">
              Save Changes
            </a-button>
          </a-form-item>
        </a-form>
      </div>
      <div v-else class="no-package-message">
        <a-empty description="No package available for this customer" />
      </div>
    </a-modal>
  </div>
</template>

<script setup>
import { ref, onMounted, onUnmounted, watch, computed, h } from 'vue'
import { message, Tooltip as ATooltip } from 'ant-design-vue'
import { api } from '../api/api'
import { useRouter } from 'vue-router'
import dayjs from 'dayjs'
import { 
  CalendarOutlined,
  WarningOutlined,
  FilterOutlined,
  WifiOutlined,
  TeamOutlined,
  DeploymentUnitOutlined,
  PlayCircleOutlined,
  UserOutlined,
  LoadingOutlined
} from '@ant-design/icons-vue'
import { use } from "echarts/core";
import VChart from "vue-echarts";
import { LineChart } from "echarts/charts";
import { TitleComponent, TooltipComponent, GridComponent, LegendComponent } from "echarts/components";
import { CanvasRenderer } from "echarts/renderers";
use([LineChart, TitleComponent, TooltipComponent, GridComponent, LegendComponent, CanvasRenderer]);

const loading = ref(false)
const pagination = ref({
  current: 1,
  pageSize: 10,
  total: 0,
  showTotal: total => `${total} records in total`,
  showSizeChanger: false,
  showQuickJumper: true,
})

// 新增：错误仪表盘相关状态
const errorDashboardLoading = ref(false)
const errorDashboardData = ref(null)
const errorDashboardDays = ref(15) // 新增: 默认显示最近1天的数据
const errorDashboardDateOptions = [ // 新增: 日期选项
  { value: 1, label: 'Last 1 Day' },
  { value: 3, label: 'Last 3 Days' },
  { value: 7, label: 'Last 7 Days' },
  { value: 15, label: 'Last 15 Days' },
  { value: 30, label: 'Last 30 Days' },
]

// 新增：获取错误仪表盘数据函数
const fetchErrorDashboardData = async () => {
  errorDashboardLoading.value = true
  try {
    // 计算开始和结束日期
    const endDate = dayjs()
    const startDate = endDate.subtract(errorDashboardDays.value, 'day')

    // 调用 api.getErrorDashboard 并传入 YYYY-MM-DD 格式的日期参数
    // api.getErrorDashboard 返回的是 { code, message, data: [...] } 结构
    const response = await api.getErrorDashboard({
        startDate: startDate.format('YYYY-MM-DD'),
        endDate: endDate.format('YYYY-MM-DD'),
    })

    // 修改: 从返回的对象中提取 data 属性（这才是真正的数组）
    // 确保 response 存在并且 response.data 是一个数组
    const actualDataArray = response && Array.isArray(response.data) ? response.data : [];

    errorDashboardData.value = actualDataArray;
    console.log('Error Dashboard Data (final):', errorDashboardData.value) // 添加日志确认最终值

  } catch (error) {
    console.error('Failed to fetch error dashboard data:', error)
    message.error('Failed to fetch error dashboard data')
    errorDashboardData.value = [] // 出错时设置为空数组
  } finally {
    errorDashboardLoading.value = false
  }
}

// 新增: 处理错误仪表盘日期范围变化的函数
const handleErrorDashboardDateChange = () => {
  fetchErrorDashboardData() // 重新获取数据
}

// 新增: 错误仪表盘图表配置
const errorDashboardChartOption = computed(() => {
  const data = errorDashboardData.value || [];
  const dateList = data.map(item => item.date);
  const totalTasksList = data.map(item => item.totalTasks);
  const failedTasksList = data.map(item => item.failedTasks);
  // 失败率可以作为提示信息显示，或者使用双 Y 轴（更复杂）
  // const failureRateList = data.map(item => parseFloat(item.failureRate) || 0);

  return {
    tooltip: {
      trigger: 'axis',
      formatter: (params) => { // 自定义 tooltip 显示内容
        let tooltipStr = `${params[0].axisValueLabel}<br/>`;
        params.forEach(item => {
          const seriesName = item.seriesName;
          const value = item.value;
          // 查找原始数据以获取失败率
          const originalData = data.find(d => d.date === item.axisValueLabel);
          let rateStr = '';
          if (seriesName === 'Failed Tasks' && originalData) {
            rateStr = ` (${originalData.failureRate})`;
          } else if (seriesName === 'Total Tasks' && originalData && originalData.totalTasks > 0) {
             // 可选：如果需要在 Total Tasks 旁边也显示失败率
             // rateStr = ` (Failure Rate: ${originalData.failureRate})`;
          }
          tooltipStr += `${item.marker}${seriesName}: ${value}${rateStr}<br/>`;
        });
        return tooltipStr;
      }
    },
    legend: { // 添加图例
      data: ['Total Tasks', 'Failed Tasks'],
      top: 'bottom', // 图例放在底部
      padding: [20, 0, 0, 0] // 增加底部内边距给图例空间
    },
    grid: { left: 50, right: 20, top: 40, bottom: 60 }, // 调整 grid 留出图例空间
    xAxis: {
      type: 'category',
      data: dateList,
      boundaryGap: false,
    },
    yAxis: {
      type: 'value',
      minInterval: 1, // 保证 Y 轴刻度是整数
      min: 0
    },
    series: [
      {
        name: 'Total Tasks',
        type: 'line',
        data: totalTasksList,
        smooth: true,
        symbol: 'circle',
        lineStyle: { color: '#5470c6' }, // 蓝色系
        itemStyle: { color: '#5470c6' }
      },
      {
        name: 'Failed Tasks',
        type: 'line',
        data: failedTasksList,
        smooth: true,
        symbol: 'circle',
        lineStyle: { color: '#ee6666' }, // 红色系
        itemStyle: { color: '#ee6666' }
      }
      // 如果需要显示失败率作为单独的线（可能需要双 Y 轴）
      // {
      //   name: 'Failure Rate',
      //   type: 'line',
      //   yAxisIndex: 1, // 需要配置第二个 Y 轴
      //   data: failureRateList,
      //   smooth: true,
      //   symbol: 'circle',
      //   lineStyle: { color: '#91cc75' }, // 绿色系
      //   itemStyle: { color: '#91cc75' }
      // }
    ]
    // 如果需要双 Y 轴，取消注释下面的 yAxis 配置
    // yAxis: [
    //   { // 第一个 Y 轴（任务数）
    //     type: 'value',
    //     name: 'Tasks',
    //     minInterval: 1,
    //     min: 0
    //   },
    //   { // 第二个 Y 轴（失败率）
    //     type: 'value',
    //     name: 'Failure Rate (%)',
    //     min: 0,
    //     max: 100, // 假设失败率最大为 100%
    //     axisLabel: {
    //       formatter: '{value} %'
    //     }
    //   }
    // ],
  };
});

// Customer Table Columns
const initializationColumns = [
  { title: 'Customer ID', dataIndex: 'customerId', key: 'customerId', width: 150, ellipsis: true },
  { title: 'Email', dataIndex: 'email', key: 'email', width: 200, ellipsis: true },
  { title: 'Invite Code', dataIndex: 'inviteCode', key: 'inviteCode', width: 120 },
  {
    title: 'Recent Errors (Last 15 Days)',
    dataIndex: 'hasRecentErrors',
    key: 'recentErrors',
    width: 180,
    customRender: ({ record }) => {
      if (record.hasRecentErrors === true) {
        return h('span', { style: { color: '#faad14' } }, [
          h(WarningOutlined, { style: { marginRight: '8px' } }),
          'Errors encountered'
        ]);
      } else if (record.hasRecentErrors === false) {
        return h('span', { style: { color: '#52c41a' } }, '-');
      } else {
        return h('span', {}, 'Checking...');
      }
    },
  },
  {
    title: 'Register Time',
    dataIndex: 'registerTime',
    key: 'registerTime',
    width: 180,
    customRender: ({ text }) => text ? dayjs(text).format('YYYY-MM-DD HH:mm:ss') : '-',
  },
  {
    title: 'Actions',
    key: 'action',
    fixed: 'right',
    width: 200,
  },
]

// 客户列表数据
const customers = ref([])
const selectedCustomerId = ref(null)
const selectedCustomer = ref(null)

// 获取行样式
const getRowClassName = (record) => {
  return record.customerId === selectedCustomerId.value ? 'selected-row' : ''
}

// 行选择变化处理
const onSelectChange = (selectedRowKeys) => {
  if (selectedRowKeys.length > 0) {
    selectedCustomerId.value = selectedRowKeys[0]
    selectedCustomer.value = customers.value.find(c => c.customerId === selectedCustomerId.value)
    loadCustomerData(selectedCustomerId.value)
  }
}

// 在 script setup 中添加以下代码
const searchEmail = ref('') // 搜索关键词
const originalCustomers = ref([]) // 保存原始客户数据

// 新增：筛选条件状态
const taskStatusFilter = ref('all')
const resultStatusFilter = ref('all')
const deployStatusFilter = ref('all')
const subscribeFilter = ref(true) // 新增：订阅状态筛选，默认为true（只显示订阅用户）
const domainBindFilter = ref(false) // 新增：域名绑定筛选，默认为false（不开启筛选）

// 新增：筛选开关状态
const enableWebsiteCountFilter = ref(false)
const enableResultCountFilter = ref(false)
const enableDeployCountFilter = ref(false)

// 数字范围筛选条件状态
const minWebsiteCount = ref(null)
const maxWebsiteCount = ref(null)
const minResultCount = ref(null)
const maxResultCount = ref(null)
const minDeployCount = ref(null)
const maxDeployCount = ref(null)

// 修改 fetchCustomerData 函数，添加筛选参数
const fetchCustomerData = async (page = 1) => {
  loading.value = true;
  selectedCustomerId.value = null;
  selectedCustomer.value = null;
  errorLogs.value = [];

  try {
    // 构建筛选参数
    const filterParams = buildFilterParams();

    console.log('Filter Params:', filterParams);
    
    // 构建请求参数，只有当email有值时才包含email参数
    const requestParams = { 
      page, 
      limit: pagination.value.pageSize,
      ...filterParams // 添加筛选参数
    };
    
    // 只有当searchEmail有值时才添加email参数
    if (searchEmail.value && searchEmail.value.trim()) {
      requestParams.email = searchEmail.value.trim();
    }
    
    const customerResponse = await api.getCustomerList(requestParams);
    
    const rawCustomers = customerResponse.data || [];
    pagination.value.total = customerResponse.TotalCount || 0;
    pagination.value.current = page;

    const customersWithStatus = rawCustomers.map(c => ({ ...c, hasRecentErrors: null }));
    originalCustomers.value = customersWithStatus;
    customers.value = customersWithStatus;

    // Prepare error check promises
    const errorCheckPromises = rawCustomers.map(customer => {
      const endTime = dayjs();
      const startTime = endTime.subtract(15, 'day'); // Check last 15 days
      return api.getAlternativelyErrors({
        customerId: customer.customerId,
        startTime: startTime.format('YYYY-MM-DD'),
        endTime: endTime.format('YYYY-MM-DD'),
        page: 1,
        limit: 1, // We only need to know if *any* error exists (count > 0)
      }).then(response => ({
        customerId: customer.customerId,
        hasErrors: (response.totalCount || 0) > 0,
      })).catch(err => {
        console.error(`Failed to check errors for ${customer.customerId}:`, err);
        return { customerId: customer.customerId, hasErrors: false, error: true }; // Assume no errors on failure for safety, maybe log?
      });
    });

    // Wait for all error checks to complete
    const errorResults = await Promise.allSettled(errorCheckPromises);

    // Update customer data with error status
    const finalCustomers = customers.value.map(customer => {
      const result = errorResults.find(r => r.status === 'fulfilled' && r.value.customerId === customer.customerId);
      if (result) {
        return { ...customer, hasRecentErrors: result.value.hasErrors };
      }
      // Handle potential rejections if needed, though catch above defaults to false
      return { ...customer, hasRecentErrors: false }; // Default if promise failed unexpectedly
    });

    customers.value = finalCustomers;

  } catch (error) {
    console.error('Failed to fetch customer list:', error);
    message.error('Failed to load customer list');
    customers.value = [];
    originalCustomers.value = [];
    pagination.value.total = 0;
  } finally {
    loading.value = false;
  }
};

// 修改：构建筛选参数的函数
const buildFilterParams = () => {
  const params = {};
  
  // 订阅状态筛选 - 始终传递此参数
  params.subscribeFilter = subscribeFilter.value;
  
  // 域名绑定筛选 - 始终传递此参数
  params.domainBindFilter = domainBindFilter.value;
  console.log('Domain Bind Filter:', params.domainBindFilter);
  
  // 任务数量筛选 - 只有开启时才传递参数
  if (enableWebsiteCountFilter.value) {
    if (minWebsiteCount.value !== null && minWebsiteCount.value !== undefined) {
      params.minWebsiteCount = minWebsiteCount.value;
    }
    if (maxWebsiteCount.value !== null && maxWebsiteCount.value !== undefined) {
      params.maxWebsiteCount = maxWebsiteCount.value;
    }
  }
  
  // 生成页面数筛选 - 只有开启时才传递参数
  if (enableResultCountFilter.value) {
    if (minResultCount.value !== null && minResultCount.value !== undefined) {
      params.minResultCount = minResultCount.value;
    }
    if (maxResultCount.value !== null && maxResultCount.value !== undefined) {
      params.maxResultCount = maxResultCount.value;
    }
  }
  
  // 部署数量筛选 - 只有开启时才传递参数
  if (enableDeployCountFilter.value) {
    if (minDeployCount.value !== null && minDeployCount.value !== undefined) {
      params.minDeployCount = minDeployCount.value;
    }
    if (maxDeployCount.value !== null && maxDeployCount.value !== undefined) {
      params.maxDeployCount = maxDeployCount.value;
    }
  }
  
  return params;
};

// 修改：处理筛选条件变化（防抖处理）
let filterTimeout = null;
const handleFilterChange = () => {
  if (filterTimeout) {
    clearTimeout(filterTimeout);
  }
  filterTimeout = setTimeout(() => {
    pagination.value.current = 1; // 重置到第一页
    fetchCustomerData(1);
  }, 500); // 500ms 防抖
};

// 新增：清空筛选条件
const clearFilters = () => {
  // 关闭所有筛选开关
  enableWebsiteCountFilter.value = false;
  enableResultCountFilter.value = false;
  enableDeployCountFilter.value = false;
  domainBindFilter.value = false; // 新增：重置域名绑定筛选
  
  // 重置订阅筛选为默认值
  subscribeFilter.value = true;
  
  // 清空所有数值
  minWebsiteCount.value = null;
  maxWebsiteCount.value = null;
  minResultCount.value = null;
  maxResultCount.value = null;
  minDeployCount.value = null;
  maxDeployCount.value = null;
  
  pagination.value.current = 1;
  fetchCustomerData(1);
};

// 新增：应用筛选条件
const applyFilters = () => {
  pagination.value.current = 1;
  fetchCustomerData(1);
};

// 修改: 处理搜索
const handleSearch = () => {
  pagination.value.current = 1; // 重置到第一页
  fetchCustomerData(1);
};

// 修改: 处理搜索框值变化
const handleSearchChange = (e) => {
  if (!e.target.value) {
    searchEmail.value = '';
    fetchCustomerData(1);
  }
};

// 处理初始化按钮点击
const handleInitialize = (record) => {
  selectedCustomerId.value = record.customerId
  selectedCustomer.value = record
  loadCustomerData(record.customerId)
}

// 加载客户相关数据
const loadCustomerData = async (customerId) => {
  // 重置错误日志状态
  errorLogs.value = [];
  errorLogPagination.value.current = 1;
  errorLogPagination.value.total = 0;
  // 获取错误日志 (使用当前选定的日期范围)
  await fetchErrorLogs(customerId, 1); // 默认加载第一页
}

// 添加新的套餐相关状态
const modalVisible = ref(false)
const packageLoading = ref(false)
const packageList = ref([])
const selectedPackage = ref(null)
const saving = ref(false)

// 处理编辑计划按钮点击
const handleEditPlan = async (record) => {
  modalVisible.value = true
  packageLoading.value = true
  try {
    const response = await api.getTrialPackages({
      customerId: record.customerId,
      page: 1,
      limit: 10
    })
    // 检查是否有套餐数据
    if (response.data && response.data.length > 0) {
      const packageData = response.data[0]
      selectedPackage.value = {
        ...packageData,
        startTime: packageData.startTime ? dayjs(packageData.startTime) : null,
        endTime: packageData.endTime ? dayjs(packageData.endTime) : null,
        packageFeatureId: packageData.packageId
      }
    } else {
      selectedPackage.value = null
    }
  } catch (error) {
    console.error('Failed to fetch trial packages:', error)
    message.error('Failed to fetch trial packages')
  } finally {
    packageLoading.value = false
  }
}

// 获取套餐列表
const fetchPackageList = async () => {
  try {
    const response = await api.getPackageFeatures()
    packageList.value = response.data
  } catch (error) {
    console.error('Failed to fetch package list:', error)
    message.error('Failed to get package list')
  }
}

// 保存套餐变更
const handleSave = async () => {
  if (!selectedPackage.value) return
  
  saving.value = true
  try {
    const updateData = {
      startTime: selectedPackage.value.startTime.format('YYYY-MM-DD'),
      endTime: selectedPackage.value.endTime.format('YYYY-MM-DD'),
      packageFeatureId: selectedPackage.value.packageFeatureId
    }
    
    await api.updateTrialPackage(selectedPackage.value.trialId, updateData)
    message.success('Updated successfully')
    modalVisible.value = false
  } catch (error) {
    console.error('Failed to update trial package:', error)
    message.error('Update failed')
  } finally {
    saving.value = false
  }
}

// 格式化竞争产品显示
const formatCompeteProducts = (text) => {
  if (!text) return '-'
  return text.split(',')
    .map(item => item.split('|')[0])
    .join(', ')
}

// 格式化竞争产品网站显示
const formatCompeteProductSites = (text) => {
  if (!text) return '-'
  const sites = text.split(',')
    .map(item => {
      const parts = item.split('|')
      return parts.length > 1 ? parts[1] : ''
    })
    .filter(site => site) // 过滤掉空值
  
  return sites.length > 0 ? sites.join(', ') : '-'
}

// 处理表格分页变化
const handleTableChange = (pag) => {
  pagination.value.current = pag.current
  fetchCustomerData(pag.current)
}

// Keywords types configuration
const keywordTypes = [
  { key: 'common', label: 'Common Keywords' },
  { key: 'absence', label: 'Absence Keywords' },
  { key: 'weak', label: 'Weak Keywords' },
  { key: 'strong', label: 'Strong Keywords' },
  { key: 'undeveloped', label: 'Undeveloped Keywords' },
  { key: 'unique', label: 'Unique Keywords' },
  { key: 'all', label: 'All Keywords' },
]

const activeKeywordsType = ref('common')

// 关键词数据状态
const keywordsLoading = ref(keywordTypes.reduce((acc, type) => {
  acc[type.key] = false
  return acc
}, {}))

const keywordsData = ref(keywordTypes.reduce((acc, type) => {
  acc[type.key] = []
  return acc
}, {}))

// 竞争对手相关状态
const competitorsLoading = ref({})
const competitorsData = ref({})
const competitors = ref([])
const activeCompetitorKey = ref('')

// 关键词列定义
const keywordsColumns = [
  {
    title: 'Keyword',
    dataIndex: 'keyword',
    key: 'keyword',
  },
  {
    title: 'Intent',
    dataIndex: 'intent',
    key: 'intent',
  },
  {
    title: 'Volume',
    dataIndex: 'volume',
    key: 'volume',
    sorter: (a, b) => a.volume - b.volume,
  },
  {
    title: 'Keyword Difficulty',
    dataIndex: 'keyword_difficulty',
    key: 'keyword_difficulty',
    sorter: (a, b) => a.keyword_difficulty - b.keyword_difficulty,
  },
  {
    title: 'CPC',
    dataIndex: 'cpc',
    key: 'cpc',
    sorter: (a, b) => a.cpc - b.cpc,
  },
  {
    title: 'Competition Density',
    dataIndex: 'competition_density',
    key: 'competition_density',
    sorter: (a, b) => a.competition_density - b.competition_density,
  }
]

// 竞争对手列定义
const competitorsColumns = [
  {
    title: 'URL',
    dataIndex: 'URL',
    key: 'URL',
  },
  {
    title: 'Traffic',
    dataIndex: 'traffic',
    key: 'traffic',
    sorter: (a, b) => a.traffic - b.traffic,
  },
  {
    title: 'Traffic Value',
    dataIndex: 'trafficValue',
    key: 'trafficValue',
    sorter: (a, b) => a.trafficValue - b.trafficValue,
  },
  {
    title: 'Keywords',
    dataIndex: 'keywords',
    key: 'keywords',
    sorter: (a, b) => a.keywords - b.keywords,
  },
  {
    title: 'Top Keyword',
    dataIndex: 'topKeyword',
    key: 'topKeyword',
  },
  {
    title: 'Top Keyword Volume',
    dataIndex: 'topKeywordVolume',
    key: 'topKeywordVolume',
    sorter: (a, b) => a.topKeywordVolume - b.topKeywordVolume,
  },
  {
    title: 'Top Keyword Position',
    dataIndex: 'topKeywordPosition',
    key: 'topKeywordPosition',
    sorter: (a, b) => a.topKeywordPosition - b.topKeywordPosition,
  },
  {
    title: 'Actions',
    key: 'actions',
    fixed: 'right',
    width: 120,
    slots: {
      customRender: 'actions',
    },
  }
]

// 分页相关状态
const currentPage = ref(keywordTypes.reduce((acc, type) => {
  acc[type.key] = 1
  return acc
}, {}))

const totalCount = ref(keywordTypes.reduce((acc, type) => {
  acc[type.key] = 0
  return acc
}, {}))

// 获取关键词数据
const fetchKeywordsData = async (customerId, type, page = 1) => {
  keywordsLoading.value[type] = true
  try {
    const response = await api.searchKeywords({
      customerId,
      keywordType: type,
      page,
      limit: 10
    })
    keywordsData.value[type] = response.data || []
    totalCount.value[type] = response.total || response.totalPage * 10 || 0
    currentPage.value[type] = page
  } catch (error) {
    console.error(`Failed to fetch ${type} keywords:`, error)
    message.error(`Failed to load ${type} keywords data`)
  } finally {
    keywordsLoading.value[type] = false
  }
}

// 获取竞争对手数据
const fetchCompetitorData = async (competitorUrl) => {
  console.log(`Starting fetchCompetitorData for URL: ${competitorUrl}`)
  competitorsLoading.value[competitorUrl] = true
  
  try {
    const response = await api.getTopPages({
      customerId: selectedCustomerId.value,
      domainName: competitorUrl,
      page: 1,
      limit: 20
    })
    console.log(`Received data for ${competitorUrl}:`, response)
    competitorsData.value[competitorUrl] = response.data || []
  } catch (error) {
    console.error(`Error fetching data for ${competitorUrl}:`, error)
    competitorsData.value[competitorUrl] = []
  } finally {
    competitorsLoading.value[competitorUrl] = false
  }
}

// 上传关键词文件前的处理
const beforeUploadKeywords = (file, type) => {
  const isValidFormat = file.type === 'text/csv' || 
    file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
  
  if (!isValidFormat) {
    message.error('Please upload CSV or XLSX format files!')
    return false
  }

  handleKeywordsFile(file, type)
  return false
}

// 上传竞争对手文件前的处理
const beforeUploadCompetitors = (file, competitorUrl) => {
  const isValidFormat = file.type === 'text/csv' || 
    file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
  
  if (!isValidFormat) {
    message.error('Please upload CSV or XLSX format files!')
    return false
  }

  handleCompetitorsFile(file, competitorUrl)
  return false
}

// 处理关键词文件上传
const handleKeywordsFile = async (file, type) => {
  if (!selectedCustomerId.value) {
    message.error('Please select a customer first')
    return
  }

  keywordsLoading.value[type] = true
  try {
    // Set timeout to 30 seconds
    const response = await api.uploadKeywords(file, selectedCustomerId.value, type, { timeout: 30000 })
    
    keywordsData.value[type] = response.data || []
    message.success(`${type} keywords data uploaded successfully!`)
  } catch (error) {
    console.error('Keywords upload failed:', error)
    message.error('File processing failed: ' + (error.response?.data?.message || error.message))
  } finally {
    keywordsLoading.value[type] = false
  }
}

// 处理竞争对手文件上传
const handleCompetitorsFile = async (file, competitorUrl) => {
  if (!selectedCustomerId.value) {
    message.error('Please select a customer first')
    return
  }

  competitorsLoading.value[competitorUrl] = true
  try {
    // 从 URL 中提取域名
    const domainName = competitorUrl
    const response = await api.uploadTopPages(file, selectedCustomerId.value, domainName)
    competitorsData.value[competitorUrl] = response.data || []
    message.success(`Top pages data for competitor uploaded successfully!`)
  } catch (error) {
    console.error('Top pages upload failed:', error)
    message.error('File processing failed: ' + (error.response?.data?.message || error.message))
  } finally {
    competitorsLoading.value[competitorUrl] = false
  }
}

// 处理页面切换
const handlePageChange = async (page, type) => {
  if (selectedCustomerId.value) {
    await fetchKeywordsData(selectedCustomerId.value, type, page)
  }
}

// 关键词模态框相关状态
const isKeywordsModalVisible = ref(false)
const currentTopPageUrl = ref('')
const topPageKeywords = ref([])
const topPageKeywordsLoading = ref(false)

// 顶级页面关键词列定义
const topPageKeywordsColumns = [
  {
    title: 'Keyword',
    dataIndex: 'keyword',
    key: 'keyword',
    width: '200px',
    ellipsis: true,
    fixed: 'left',
  },
  {
    title: 'Pos',
    dataIndex: 'currentPosition',
    key: 'currentPosition',
    width: '60px',
    sorter: (a, b) => a.currentPosition - b.currentPosition,
  },
  {
    title: 'URL Inside',
    dataIndex: 'currentURLInside',
    key: 'currentURLInside',
    width: '100px',
    ellipsis: true,
  },
  {
    title: 'Vol',
    dataIndex: 'volume',
    key: 'volume',
    width: '70px',
    sorter: (a, b) => a.volume - b.volume,
  },
  {
    title: 'KD',
    dataIndex: 'KD',
    key: 'KD',
    width: '60px',
    sorter: (a, b) => a.KD - b.KD,
  },
  {
    title: 'CPC',
    dataIndex: 'CPC',
    key: 'CPC',
    width: '70px',
    sorter: (a, b) => a.CPC - b.CPC,
  },
  {
    title: 'Organic',
    dataIndex: 'organicTraffic',
    key: 'organicTraffic',
    width: '80px',
    sorter: (a, b) => a.organicTraffic - b.organicTraffic,
  },
  {
    title: 'Paid',
    dataIndex: 'paidTraffic',
    key: 'paidTraffic',
    width: '70px',
    sorter: (a, b) => a.paidTraffic - b.paidTraffic,
  },
  {
    title: 'SERP Features',
    dataIndex: 'serpFeatures',
    key: 'serpFeatures',
    width: '150px',
    ellipsis: true,
  },
  {
    title: 'Intent',
    key: 'intent',
    width: '150px',
    ellipsis: true,
    customRender: ({ record }) => {
      const intents = [];
      if (record.informational) intents.push('Info');
      if (record.commercial) intents.push('Comm');
      if (record.transactional) intents.push('Trans');
      if (record.navigational) intents.push('Nav');
      if (record.local) intents.push('Local');
      if (record.branded) intents.push('Brand');
      return intents.join(', ');
    }
  },
  {
    title: 'Updated',
    dataIndex: 'updated',
    key: 'updated',
    width: '120px',
  }
]

// 顶级页面关键词分页状态
const topPageKeywordsPagination = ref({
  current: 1,
  pageSize: 20,
  total: 0
})

// 显示关键词模态框
const showKeywordsModal = async (url) => {
  currentTopPageUrl.value = url
  isKeywordsModalVisible.value = true
  await fetchTopPageKeywords(url)
}

// 获取顶级页面关键词
const fetchTopPageKeywords = async (url, page = 1) => {
  topPageKeywordsLoading.value = true
  try {
    const response = await api.getTopPageKeywords({
      customerId: selectedCustomerId.value,
      topURL: url,
      page,
      limit: topPageKeywordsPagination.value.pageSize
    })
    topPageKeywords.value = response.data || []
    topPageKeywordsPagination.value = {
      ...topPageKeywordsPagination.value,
      current: page,
      total: response.totalCount || 0
    }
  } catch (error) {
    console.error('Failed to fetch top page keywords:', error)
    message.error('Failed to load keywords data')
  } finally {
    topPageKeywordsLoading.value = false
  }
}

// 处理顶级页面关键词表格变化
const handleTopPageKeywordsTableChange = async (pagination) => {
  await fetchTopPageKeywords(currentTopPageUrl.value, pagination.current)
}

// 处理顶级页面关键词上传
const handleTopPageKeywordsUpload = async (file) => {
  if (!selectedCustomerId.value || !currentTopPageUrl.value) {
    message.error('Invalid operation')
    return false
  }

  const isValidFormat = file.type === 'text/csv' || 
    file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
  
  if (!isValidFormat) {
    message.error('Please upload CSV or XLSX format files!')
    return false
  }

  topPageKeywordsLoading.value = true
  try {
    await api.uploadTopPageKeywords(file, selectedCustomerId.value, currentTopPageUrl.value)
    message.success('Keywords uploaded successfully')
    await fetchTopPageKeywords(currentTopPageUrl.value)
  } catch (error) {
    console.error('Failed to upload keywords:', error)
    message.error('Failed to upload keywords')
  } finally {
    topPageKeywordsLoading.value = false
  }
  return false
}

// 开始分析处理
const handleStartAnalysis = async () => {
  if (!selectedCustomerId.value) {
    message.error('Please select a customer first');
    return;
  }

  try {
    await api.startAnalysis(selectedCustomerId.value);
    message.success('Analysis started successfully');
    // 可以在这里添加导航到分析页面的逻辑
  } catch (error) {
    message.error('Failed to start analysis: ' + (error.response?.data?.message || error.message));
  }
};

// 在script setup部分添加自定义行处理函数
const customRowHandler = (record) => {
  return {
    onClick: () => {
      if (selectedCustomerId.value !== record.customerId) { // 仅在切换客户时执行
        selectedCustomerId.value = record.customerId
        selectedCustomer.value = record
        loadCustomerData(record.customerId) // 这个函数现在会加载错误日志
      }
    }
  }
}

// 处理登录客户账号
const handleLoginAsCustomer = async (record) => {
  try {
    const response = await api.adminLoginAsCustomer(record.customerId)
    if (response && response.accessToken) {
      // 清除现有的本地存储数据
      const keysToRemove = [
        'accessToken',
        'intelickIsLoggedIn',
        'currentCustomerEmail',
        'currentCustomerId',
        'rememberedCredentials'
      ]
      keysToRemove.forEach(key => localStorage.removeItem(key))
      
      // 设置新的登录信息
      localStorage.setItem('intelickIsLoggedIn', 'true')
      localStorage.setItem('accessToken', response.accessToken)
      
      let customerId = '';
      let customerEmail = '';
      
      if (response.data) {
        customerId = response.data.customerId || '';
        customerEmail = response.data.email || '';
        localStorage.setItem('currentCustomerId', customerId)
        localStorage.setItem('currentCustomerEmail', customerEmail)
      }
      
      // 使用 URL 参数传递 token、customerId 和 customerEmail 进行跳转
      const authUrl = `https://app.websitelm.com/auth?token=${encodeURIComponent(response.accessToken)}&customerId=${encodeURIComponent(customerId)}&customerEmail=${encodeURIComponent(customerEmail)}`;
      
      // 在新标签页中打开链接
      window.open(authUrl, '_blank');
      
      message.success(`Successfully logged in as ${record.productName}`)
    }
  } catch (error) {
    console.error('Failed to login as customer:', error)
    message.error('Failed to login as customer')
  }
}

// 处理登录到Altpage
const handleLoginToAltpage = async (record) => {
  try {
    const response = await api.adminLoginAsCustomer(record.customerId)
    if (response && response.accessToken) {
      // 清除现有的本地存储数据
      const keysToRemove = [
        'alternativelyAccessToken',
        'alternativelyIsLoggedIn',
        'alternativelyCustomerEmail',
        'alternativelyCustomerId'
      ]
      keysToRemove.forEach(key => localStorage.removeItem(key))
      
      // 设置新的登录信息
      localStorage.setItem('alternativelyIsLoggedIn', 'true')
      localStorage.setItem('alternativelyAccessToken', response.accessToken)
      
      let customerId = '';
      let customerEmail = '';
      
      if (response.data) {
        customerId = response.data.customerId || '';
        customerEmail = response.data.email || '';
        localStorage.setItem('alternativelyCustomerId', customerId)
        localStorage.setItem('alternativelyCustomerEmail', customerEmail)
      }
      
      // 使用正确的URL格式，不包含auth路径
      const authUrl = `https://seopage.ai/?accessToken=${encodeURIComponent(response.accessToken)}&customerId=${encodeURIComponent(customerId)}&email=${encodeURIComponent(customerEmail)}`;
      
      // 在新标签页中打开链接
      window.open(authUrl, '_blank');
      
      message.success(`Successfully logged in to Altpage as ${record.productName}`)
    }
  } catch (error) {
    console.error('Failed to login to Altpage:', error)
    message.error('Failed to login to Altpage')
  }
}

// 注册用户统计相关状态
const registerStats = ref([]) // 原始数据
const registerStatsDays = ref(30) // 默认30天
const registerChartData = ref([]) // 处理后的折线图数据

const HIGHLIGHT_DATE = '2025-04-15'

// 修改：基于新接口数据的图表配置
const registerChartOption = computed(() => {
  const data = customerRegisterStatisticData.value?.data || [];
  const dateList = data.map(item => item.date);
  const countList = data.map(item => item.count);
  
  return {
    tooltip: { 
      trigger: 'axis',
      formatter: (params) => {
        const date = params[0].axisValueLabel;
        const count = params[0].value;
        return `${date}<br/>注册数: ${count}`;
      }
    },
    grid: { left: 40, right: 20, top: 40, bottom: 160 },
    xAxis: {
      type: 'category',
      data: dateList,
      boundaryGap: false,
      axisLabel: {
        rotate: 45,
        fontSize: 16,
        fontWeight: 'bold',
        formatter: function (value) {
          if (value === HIGHLIGHT_DATE) {
            return '{highlight|' + value + '}\n{tag|🚀 Service First Online}'
          }
          return value
        },
        rich: {
          highlight: {
            fontWeight: 'bold',
            fontSize: 16,
          },
          tag: {
            color: '#ff4d4f',
            fontSize: 18,
            fontWeight: 'bold',
            backgroundColor: '#fffbe6',
            borderRadius: 6,
            padding: [4, 8, 4, 8],
            lineHeight: 28,
          }
        }
      }
    },
    yAxis: { type: 'value', minInterval: 1, min: 0 },
    series: [
      {
        name: 'Registrations',
        type: 'line',
        data: countList,
        smooth: true,
        symbol: 'circle',
        lineStyle: {
          width: 3,
          color: {
            type: 'linear',
            x: 0,
            y: 0,
            x2: 1,
            y2: 0,
            colorStops: [
              { offset: 0, color: '#00c6fb' },
              { offset: 1, color: '#005bea' }
            ]
          }
        },
        itemStyle: {
          color: '#00c6fb',
          borderColor: '#fff',
          borderWidth: 2
        },
        areaStyle: {
          color: {
            type: 'linear',
            x: 0,
            y: 0,
            x2: 0,
            y2: 1,
            colorStops: [
              { offset: 0, color: 'rgba(0,198,251,0.3)' },
              { offset: 1, color: 'rgba(0,91,234,0.05)' }
            ]
          }
        }
      }
    ]
  }
})

// 新增：获取客户注册统计信息
const fetchCustomerRegisterStatistic = async () => {
  customerRegisterStatisticLoading.value = true
  try {
    const response = await api.getCustomerRegisterStatistic()
    customerRegisterStatisticData.value = response
    console.log('Customer Register Statistic Data:', response)
  } catch (error) {
    console.error('Failed to fetch customer register statistic:', error)
    message.error('获取客户注册统计信息失败')
    customerRegisterStatisticData.value = null
  } finally {
    customerRegisterStatisticLoading.value = false
  }
}

// 新增：邀请码注册数量统计
const inviteCodeStats = computed(() => {
  // 由于新接口只返回日期和数量，没有邀请码信息
  // 这里暂时返回空对象，如果需要邀请码统计，可能需要其他接口
  return {};
});

// 新增：错误日志相关状态
const errorLogLoading = ref(false)
const errorLogs = ref([])
const errorLogPagination = ref({
  current: 1,
  pageSize: 5, // 每页显示5条
  total: 0,
  showTotal: total => `${total} records in total`,
  showSizeChanger: false, // 不显示切换每页条数选项
})
const errorLogDays = ref(15) // Default to last 15 days
const errorLogDateOptions = [
  { value: 1, label: 'Last 1 Day' },
  { value: 3, label: 'Last 3 Days' },
  { value: 7, label: 'Last 7 Days' },
  { value: 15, label: 'Last 15 Days' }, // Ensure 15 is an option
  { value: 30, label: 'Last 30 Days' },
]

// 新增: 错误日志表格列定义
const errorLogColumns = [
  {
    title: 'Time',
    dataIndex: 'createdAt',
    key: 'createdAt',
    width: 180,
    customRender: ({ text }) => text ? dayjs(text).format('YYYY-MM-DD HH:mm:ss') : '-',
    sorter: (a, b) => dayjs(a.createdAt).unix() - dayjs(b.createdAt).unix(),
    defaultSortOrder: 'descend' // 默认按时间降序
  },
  {
    title: 'Module',
    dataIndex: 'module',
    key: 'module',
    width: 150,
    ellipsis: true,
  },
  {
    title: 'Operation',
    dataIndex: 'operation',
    key: 'operation',
    width: 200,
    ellipsis: true,
  },
  {
    title: 'Website ID',
    dataIndex: 'websiteId',
    key: 'websiteId',
    width: 250,
    ellipsis: true,
  },
  {
    title: 'Error Details',
    dataIndex: 'errorDetail',
    key: 'errorDetail',
    ellipsis: true, // 使用 antd 的省略号功能
    customRender: ({ text }) => h(
      ATooltip,
      { title: text }, // 鼠标悬浮时显示完整内容
      () => h('span', text) // 表格单元格内显示省略的文本
    )
  },
  // 可以选择性地添加 errorId 列，如果需要的话
  // {
  //   title: 'Error ID',
  //   dataIndex: 'errorId',
  //   key: 'errorId',
  //   width: 250,
  //   ellipsis: true,
  // },
];

// 获取错误日志数据
const fetchErrorLogs = async (customerId, page = 1) => {
  if (!customerId) return;
  errorLogLoading.value = true;
  try {
    const endDate = dayjs();
    const startDate = endDate.subtract(errorLogDays.value, 'day'); // 使用 errorLogDays 控制范围

    const response = await api.getAlternativelyErrors({
      customerId: customerId,
      startTime: startDate.format('YYYY-MM-DD'),
      endTime: endDate.format('YYYY-MM-DD'),
      page: page,
      limit: errorLogPagination.value.pageSize,
    });

    // 修正：确保分页 total 和 data 数量一致
    errorLogs.value = response.data || [];
    errorLogPagination.value.total = response.totalCount || errorLogs.value.length;
    errorLogPagination.value.current = page;

  } catch (error) {
    console.error(`Failed to fetch error logs for ${customerId}:`, error);
    message.error('Failed to load error logs');
    errorLogs.value = [];
    errorLogPagination.value.total = 0;
  } finally {
    errorLogLoading.value = false;
  }
};

// 新增: 处理错误日志表格分页/排序变化
const handleErrorLogTableChange = (pagination, filters, sorter) => {
  // 更新分页信息
  errorLogPagination.value.current = pagination.current;
  errorLogPagination.value.pageSize = pagination.pageSize;

  // 如果需要处理排序，可以在这里添加逻辑
  // const { field, order } = sorter;
  // console.log('Sorter:', field, order);

  // 重新获取当前页数据
  if (selectedCustomerId.value) {
    fetchErrorLogs(selectedCustomerId.value, pagination.current);
  }
};

// 新增: 处理错误日志日期范围变化
const handleErrorLogDateChange = () => {
  // 重置到第一页并重新获取数据
  errorLogPagination.value.current = 1;
  if (selectedCustomerId.value) {
    fetchErrorLogs(selectedCustomerId.value, 1);
  }
};

// 添加移动端检测
const isMobile = ref(false)

// 检测设备类型
const checkDevice = () => {
  isMobile.value = window.innerWidth <= 768
}

// 处理客户选择（移动端）
const handleCustomerSelect = (customer) => {
  if (selectedCustomerId.value !== customer.customerId) {
    selectedCustomerId.value = customer.customerId
    selectedCustomer.value = customer
    loadCustomerData(customer.customerId)
  }
}

// 新增：SSE连接状态相关状态
const sseStatusLoading = ref(false)
const sseConnectionCount = ref(0)
const lastSSEUpdateTime = ref('')

// 新增：获取SSE连接状态
const fetchSSEStatus = async () => {
  sseStatusLoading.value = true
  try {
    // 假设API密钥从环境变量或配置中获取
    const apiKey = 'Mz7bHCyjvSqzOTfWHjUe6VO9kkSVnQvoxI2zgw3O894' // 这里需要替换为实际的API密钥
    const response = await api.getSubscriptionCount(apiKey)
    
    sseConnectionCount.value = response.connected_total || 0
    lastSSEUpdateTime.value = dayjs().format('YYYY-MM-DD HH:mm:ss')
    
    console.log('SSE Status:', response)
  } catch (error) {
    console.error('Failed to fetch SSE status:', error)
    message.error('获取SSE连接状态失败')
    sseConnectionCount.value = 0
    lastSSEUpdateTime.value = dayjs().format('YYYY-MM-DD HH:mm:ss')
  } finally {
    sseStatusLoading.value = false
  }
}

// 新增：客户统计相关状态
const customerStatisticLoading = ref(false)
const customerStatisticData = ref(null)

// 新增：获取客户统计信息
const fetchCustomerStatistic = async () => {
  customerStatisticLoading.value = true
  try {
    const response = await api.getCustomerStatistic()
    customerStatisticData.value = response
    console.log('Customer Statistic Data:', response)
  } catch (error) {
    console.error('Failed to fetch customer statistic:', error)
    message.error('获取客户统计信息失败')
    customerStatisticData.value = null
  } finally {
    customerStatisticLoading.value = false
  }
}

// 新增：格式化统计标签
const formatStatisticLabel = (key) => {
  const labelMap = {
    unsubscribeDeployOne: '未订阅，有部署页面的客户数',
    unsubscribeTaskOne: '未订阅，有开启过任务的客户数', 
    unsubscribedNoTask: '未订阅，未跑过一次任务的客户数',
  }
  return labelMap[key] || key
}

// 新增：格式化统计值
const formatStatisticValue = (value) => {
  if (typeof value === 'number') {
    return value.toLocaleString() // 添加千分位分隔符
  }
  return value || '-'
}

// 新增：计算总注册数
const totalRegistrations = computed(() => {
  return customerRegisterStatisticData.value?.totalCount || 0;
})

// 新增：客户注册统计相关状态
const customerRegisterStatisticLoading = ref(false)
const customerRegisterStatisticData = ref(null)

// 修改：计算HIGHLIGHT_DATE之后的注册总数
const totalRegistrationsAfterHighlight = computed(() => {
  const data = customerRegisterStatisticData.value?.data || [];
  const highlightDayjs = dayjs(HIGHLIGHT_DATE);
  
  return data
    .filter(item => dayjs(item.date).isAfter(highlightDayjs))
    .reduce((total, item) => total + item.count, 0);
});

// 修改组件挂载时的初始化逻辑
onMounted(async () => {
  checkDevice()
  window.addEventListener('resize', checkDevice)
  
  console.log('Component mounted, fetching initial data...')
  await fetchCustomerStatistic() // 获取客户统计
  await fetchCustomerRegisterStatistic() // 获取客户注册统计
  await fetchSSEStatus()
  await fetchErrorDashboardData()
  await fetchCustomerData()
  await fetchPackageList()
  // 移除原来的 fetchRegisterStats 调用
  
  if (customers.value.length > 0 && !selectedCustomerId.value) {
    selectedCustomerId.value = customers.value[0].customerId
    selectedCustomer.value = customers.value[0]
    await loadCustomerData(selectedCustomerId.value)
  }
  console.log('Initial data fetching complete.')
})

// 清理事件监听器
onUnmounted(() => {
  window.removeEventListener('resize', checkDevice)
})

// 新增：检查是否有激活的筛选条件
const hasActiveFilters = computed(() => {
  return enableWebsiteCountFilter.value || 
         enableResultCountFilter.value || 
         enableDeployCountFilter.value ||
         domainBindFilter.value || // 新增：域名绑定筛选激活检查
         subscribeFilter.value === false; // 当显示未订阅用户时也算作激活筛选
})

// 新增：计算百分比
const calculatePercentage = (value, total) => {
  if (!value || !total || total === 0) return '0%';
  const percentage = ((value / total) * 100).toFixed(1);
  return `${percentage}%`;
};

// 新增：计算转化率
const calculateConversionRate = (current, previous) => {
  if (!current || !previous || previous === 0) return '0%';
  const rate = ((current / previous) * 100).toFixed(1);
  return `${rate}%`;
};
</script>

<style scoped>
.initialization-container {
  padding: 16px;
  background: #fff;
  min-height: 100vh;
}

/* 移动端适配 */
@media (max-width: 768px) {
  .initialization-container {
    padding: 8px 6px;
  }
}

.section-card {
  border-radius: 8px;
  border: 1px solid #e8e8e8;
  background: #fff;
  padding: 12px;
  margin-bottom: 12px;
}

@media (max-width: 768px) {
  .section-card {
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 6px;
  }
}

.section-header {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 12px;
  width: 100%;
}

.section-title {
  font-size: 18px;
  font-weight: 600;
  color: #333;
  margin: 0;
}

.date-label {
  font-size: 14px;
  color: #666;
  white-space: nowrap;
}

.mobile-select {
  min-width: 120px;
  flex: 1;
}

@media (max-width: 768px) {
  .mobile-select {
    min-width: 100px;
  }
}

.mobile-search {
  width: 100%;
  max-width: 250px;
}

.title-and-summary-mobile {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.registration-summary-mobile {
  font-size: 13px;
  color: #555;
  background-color: #f5f5f5;
  padding: 6px 10px;
  border-radius: 4px;
}

.registration-summary-mobile .count {
  font-weight: bold;
  color: #1890ff;
  margin-left: 6px;
  font-size: 16px;
}

@media (max-width: 768px) {
  .registration-summary-mobile .count {
    font-size: 18px;
  }
}

.invite-code-stats-mobile {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  font-size: 12px;
}

.invite-code-item {
  background-color: #f5f5f5;
  padding: 2px 6px;
  border-radius: 3px;
  color: #333;
}

/* 移动端图表样式 */
.mobile-chart {
  height: 300px;
  margin-top: 12px;
}

@media (max-width: 768px) {
  .mobile-chart {
    height: 250px;
    margin-top: 8px;
  }
}

/* 移动端客户列表样式 */
.mobile-customer-list {
  margin-top: 12px;
}

.customer-card {
  border: 1px solid #e8e8e8;
  border-radius: 6px;
  padding: 10px;
  margin-bottom: 10px;
  background: #fff;
  cursor: pointer;
  transition: all 0.3s ease;
}

.customer-card:hover {
  border-color: #1890ff;
}

.customer-card.selected {
  border-color: #1890ff;
  background-color: #f0f8ff;
}

.customer-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}

.customer-email {
  font-weight: 600;
  color: #222;
  font-size: 14px;
}

.customer-status {
  font-size: 12px;
}

.error-indicator {
  color: #faad14;
}

.no-error-indicator {
  color: #52c41a;
}

.customer-details {
  margin-bottom: 10px;
}

.detail-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 3px;
  font-size: 12px;
}

.detail-item .label {
  color: #666;
  font-weight: 500;
}

.detail-item .value {
  color: #333;
  word-break: break-all;
}

.customer-actions {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
}

.customer-actions .ant-btn {
  font-size: 12px;
  height: 28px;
  padding: 0 8px;
}

/* 移动端错误日志样式 */
.mobile-error-list {
  margin-top: 12px;
}

.error-log-card {
  border: 1px solid #e8e8e8;
  border-radius: 6px;
  padding: 10px;
  margin-bottom: 6px;
  background: #fff;
}

.error-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}

.error-time {
  font-size: 12px;
  color: #666;
  font-weight: 500;
}

.error-module {
  font-size: 12px;
  background-color: #f0f0f0;
  padding: 2px 6px;
  border-radius: 3px;
  color: #333;
}

.error-operation {
  font-size: 13px;
  font-weight: 500;
  color: #333;
  margin-bottom: 4px;
}

.error-website {
  font-size: 12px;
  margin-bottom: 6px;
}

.error-website .label {
  color: #666;
  margin-right: 4px;
}

.error-website .value {
  color: #333;
  word-break: break-all;
}

.error-detail {
  font-size: 12px;
  color: #555;
  line-height: 1.4;
}

/* 移动端分页样式 */
.mobile-pagination {
  margin-top: 12px;
  text-align: center;
}

.mobile-pagination :deep(.ant-pagination) {
  justify-content: center;
}

.mobile-pagination :deep(.ant-pagination-item) {
  min-width: 28px;
  height: 28px;
  line-height: 26px;
  font-size: 12px;
}

/* 加载和空状态样式 */
.loading-container {
  text-align: center;
  padding: 30px 15px;
}

.empty-container {
  text-align: center;
  padding: 30px 15px;
}

@media (max-width: 768px) {
  .loading-container,
  .empty-container {
    padding: 20px 10px;
  }
}

/* 隐藏桌面端表格在移动端 */
@media (max-width: 768px) {
  .customer-table {
    display: none;
  }
}

/* 隐藏移动端列表在桌面端 */
@media (min-width: 769px) {
  .mobile-customer-list,
  .mobile-error-list {
    display: none;
  }
}

/* 保持原有桌面端样式 */
@media (min-width: 769px) {
  .initialization-container {
    padding: 24px 36px;
  }
  
  .section-card {
    padding: 18px 24px;
    margin-bottom: 24px;
  }
  
  .section-header {
    margin-bottom: 14px;
    padding-bottom: 6px;
  }
  
  .section-title {
    font-size: 20px;
    letter-spacing: 1px;
  }
  
  .title-and-summary-mobile {
    flex-direction: row;
    align-items: baseline;
    gap: 16px;
  }
  
  .registration-summary-mobile .count {
    font-size: 24px;
  }
}

/* 响应式图表配置 */
:deep(.echarts) {
  width: 100% !important;
}

/* 选中行样式 */
:deep(.selected-row) {
  background-color: #f0f8ff;
}

/* 表格行点击样式 */
.customer-table :deep(.ant-table-row) {
  cursor: pointer;
}

/* SSE状态样式 */
.sse-status-content {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

@media (min-width: 769px) {
  .sse-status-content {
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
  }
}

.status-item {
  display: flex;
  align-items: center;
  gap: 8px;
}

.status-label {
  font-size: 14px;
  color: #666;
  font-weight: 500;
}

.status-value {
  font-size: 14px;
  color: #333;
  font-weight: 600;
}

.active-connections {
  font-size: 18px;
  color: #1890ff;
  background-color: #f0f8ff;
  padding: 4px 12px;
  border-radius: 16px;
  border: 1px solid #d6e4ff;
}

.status-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  border-radius: 6px;
  transition: all 0.3s ease;
}

.status-indicator.online {
  background-color: #f6ffed;
  border: 1px solid #b7eb8f;
}

.status-indicator.offline {
  background-color: #fff2f0;
  border: 1px solid #ffccc7;
}

.indicator-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  display: inline-block;
}

.status-indicator.online .indicator-dot {
  background-color: #52c41a;
}

.status-indicator.offline .indicator-dot {
  background-color: #ff4d4f;
}

.indicator-text {
  font-size: 13px;
  font-weight: 500;
}

.status-indicator.online .indicator-text {
  color: #52c41a;
}

.status-indicator.offline .indicator-text {
  color: #ff4d4f;
}

@media (max-width: 768px) {
  .sse-status-content {
    gap: 8px;
  }
  
  .status-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
  }
  
  .active-connections {
    font-size: 16px;
  }
  
  .status-indicator {
    align-self: stretch;
    justify-content: center;
  }
}

/* 客户统计样式 */
.statistic-content {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 16px 0;
  width: 100%;
}

.statistic-grid-mobile {
  display: flex;
  flex-direction: column;
  gap: 12px;
  width: 100%;
  max-width: 400px;
}

.statistic-grid-desktop {
  display: flex;
  justify-content: center;
  gap: 16px;
  flex-wrap: wrap;
  width: 100%;
  max-width: 1200px;
}

.statistic-card-mobile {
  background: #fff;
  border: 1px solid #e8e8e8;
  border-radius: 6px;
  padding: 12px;
  text-align: center;
  width: 100%;
}

.statistic-item-desktop {
  background: #fff;
  border: 1px solid #e8e8e8;
  border-radius: 6px;
  padding: 16px 20px;
  text-align: center;
  flex: 1;
  min-width: 180px;
  max-width: 220px;
  transition: all 0.3s ease;
}

.statistic-item-desktop:hover {
  border-color: #1890ff;
  transform: translateY(-2px);
}

.statistic-label {
  font-size: 14px;
  color: #666;
  margin-bottom: 6px;
  font-weight: 500;
}

.statistic-value {
  font-size: 24px;
  color: #333;
  font-weight: 600;
}

@media (max-width: 768px) {
  .statistic-value {
    font-size: 20px;
  }
  
  .statistic-card-mobile {
    padding: 10px;
  }
}

/* 通知统计样式 */
.notification-stats-section {
  margin-top: 16px;
  padding: 16px;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.04);
}

.stats-title {
  font-size: 16px;
  font-weight: 700;
  color: #222;
  margin-bottom: 12px;
}

.notification-stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 16px;
}

.notification-stat-item {
  text-align: center;
}

.stat-label {
  font-size: 14px;
  color: #666;
  margin-bottom: 4px;
}

.stat-value {
  font-size: 18px;
  font-weight: 700;
  color: #1890ff;
}

/* 筛选条件样式 */
.filter-section {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-bottom: 10px;
  padding: 12px;
  background-color: #f8f9fa;
  border-radius: 6px;
  border: 1px solid #e8e8e8;
}

@media (min-width: 769px) {
  .filter-section {
    margin-bottom: 0;
    margin-right: 16px;
  }
}

.filter-row {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.filter-label {
  font-size: 13px;
  color: #666;
  font-weight: 500;
  margin-left: 4px;
}

.filter-input {
  width: 80px;
  flex-shrink: 0;
}

.filter-input:disabled {
  background-color: #f5f5f5;
  cursor: not-allowed;
}

.filter-separator {
  color: #999;
  font-weight: 500;
  margin: 0 4px;
}

.filter-actions {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
  margin-top: 6px;
  padding-top: 6px;
  border-top: 1px solid #e8e8e8;
}

@media (max-width: 768px) {
  .filter-row {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
  }
  
  .filter-row:last-of-type {
    border-bottom: none;
  }
  
  :deep(.ant-checkbox-wrapper) {
    margin-bottom: 4px;
  }
  
  .filter-input {
    width: 100px;
  }
}

/* 突出显示的统计卡片样式 */
.highlight-card {
  background: #1890ff;
  color: white;
  border: none;
}

.highlight-card .statistic-label {
  color: rgba(255, 255, 255, 0.9);
  font-weight: 600;
}

.highlight-card .statistic-value {
  color: white;
  font-weight: 700;
}

.highlight-item {
  background: #1890ff;
  color: white;
  border: none;
}

.highlight-item .statistic-label {
  color: rgba(255, 255, 255, 0.9);
  font-weight: 600;
}

.highlight-item .statistic-value {
  color: white;
  font-weight: 700;
}

/* 筛选器容器样式 */
.filter-container {
  background: #ffffff;
  border: 1px solid #e8e8e8;
  border-radius: 8px;
  overflow: hidden;
  width: 100%;
  margin: 0;
}

.filter-header {
  background: #f8f9fa;
  padding: 10px 14px;
  border-bottom: 1px solid #e8e8e8;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 10px;
  width: 100%;
}

.filter-title-section {
  display: flex;
  align-items: center;
  gap: 16px;
  flex: 1;
  min-width: 0;
}

.filter-title {
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 600;
  color: #333;
  font-size: 14px;
  white-space: nowrap;
}

.header-search-section {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
  min-width: 0;
}

.header-search-input {
  width: 200px;
  flex-shrink: 0;
}

.header-customer-stats {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  color: #666;
  white-space: nowrap;
  padding: 4px 8px;
  background: rgba(255, 255, 255, 0.8);
  border-radius: 4px;
  border: 1px solid #e8e8e8;
}

.header-customer-stats .stats-text {
  display: flex;
  align-items: center;
  gap: 2px;
}

.header-customer-stats .stats-number {
  color: #1890ff;
  font-weight: 600;
  font-size: 12px;
}

.filter-header-actions {
  display: flex;
  gap: 8px;
  flex-shrink: 0;
}

.filter-content {
  padding: 12px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 12px;
  align-items: start;
  width: 100%;
}

.filter-group {
  background: #f8f9fa;
  border: 1px solid #e8e8e8;
  border-radius: 6px;
  padding: 10px;
  transition: all 0.3s ease;
}

.filter-group:hover {
  border-color: #d9d9d9;
}

.filter-group-header {
  margin-bottom: 6px;
}

.filter-checkbox {
  font-weight: 500;
}

.filter-group-title {
  color: #333;
  font-size: 13px;
}

.filter-group-content {
  padding-left: 18px;
  transition: opacity 0.3s ease;
}

.filter-group-content.disabled {
  opacity: 0.5;
}

.range-inputs {
  display: flex;
  align-items: center;
  gap: 8px;
}

.range-input {
  width: 80px;
  flex-shrink: 0;
}

.range-separator {
  color: #999;
  font-weight: 500;
  font-size: 12px;
}

/* 移动端适配 */
@media (max-width: 768px) {
  .section-header {
    gap: 10px;
    margin-bottom: 10px;
  }

  .filter-container {
    border-radius: 6px;
  }

  .filter-header {
    padding: 8px 10px;
    flex-direction: column;
    gap: 6px;
    align-items: stretch;
  }

  .filter-title-section {
    flex-direction: column;
    gap: 6px;
    align-items: stretch;
  }

  .filter-title {
    justify-content: center;
    font-size: 13px;
  }

  .header-search-section {
    flex-direction: column;
    gap: 6px;
  }

  .header-search-input {
    width: 100%;
  }

  .header-customer-stats {
    align-self: center;
    justify-content: center;
  }

  .filter-header-actions {
    justify-content: center;
  }

  .filter-content {
    padding: 10px;
    grid-template-columns: 1fr;
    gap: 10px;
  }

  .filter-group {
    margin-bottom: 0;
    padding: 8px;
  }

  .filter-group-content {
    padding-left: 14px;
  }

  .range-inputs {
    flex-direction: column;
    align-items: stretch;
    gap: 6px;
  }

  .range-input {
    width: 100%;
  }

  .range-separator {
    text-align: center;
    padding: 2px 0;
  }
}

/* 桌面端优化 */
@media (min-width: 769px) {
  .filter-content {
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
  }

  .header-search-input {
    width: 240px;
  }
}

/* 大屏幕优化 */
@media (min-width: 1200px) {
  .filter-content {
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
  }

  .header-search-input {
    width: 280px;
  }

  .header-customer-stats .stats-text:not(:last-child)::after {
    content: '|';
    margin-left: 6px;
    margin-right: 2px;
    color: #d9d9d9;
  }
}

/* 移除原来的搜索区域样式 */
.search-section,
.search-input,
.customer-stats {
  display: none;
}

/* 桌面端单行网格布局 */
.statistic-grid-desktop-single-row {
  display: flex;
  justify-content: center;
  gap: 14px;
  margin-top: 12px;
  width: 100%;
  max-width: 1200px;
  margin-left: auto;
  margin-right: auto;
}

.statistic-grid-desktop-single-row .statistic-item-desktop {
  flex: 1;
  min-width: 160px;
  max-width: 200px;
}

/* 确保在较小的桌面屏幕上也能正常显示 */
@media (max-width: 1200px) {
  .statistic-grid-desktop-single-row {
    flex-wrap: wrap;
    justify-content: center;
  }
  
  .statistic-grid-desktop-single-row .statistic-item-desktop {
    min-width: 140px;
    max-width: 180px;
  }
}

@media (max-width: 992px) {
  .statistic-grid-desktop-single-row {
    gap: 12px;
  }
  
  .statistic-grid-desktop-single-row .statistic-item-desktop {
    min-width: 120px;
    max-width: 160px;
  }
}

@media (max-width: 768px) {
  .statistic-grid-desktop-single-row {
    display: none;
  }
}

.statistic-label {
  font-size: 12px;
  color: #666;
  margin-bottom: 6px;
  line-height: 1.4;
  min-height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
}

.statistic-value {
  font-size: 24px;
  font-weight: bold;
  color: #333;
}

.highlight-item .statistic-value {
  color: #1890ff;
}

/* 确保统计容器在所有屏幕尺寸下都居中 */
@media (min-width: 769px) {
  .statistic-content {
    padding: 18px 0;
  }
  
  .statistic-grid-desktop {
    gap: 16px;
  }
  
  .statistic-item-desktop {
    padding: 18px;
  }
}

@media (min-width: 1400px) {
  .statistic-grid-desktop-single-row {
    max-width: 1400px;
    gap: 20px;
  }
  
  .statistic-grid-desktop-single-row .statistic-item-desktop {
    max-width: 240px;
  }
}

/* 系统概览仪表盘样式 - 简化配色 */
.dashboard-section {
  background: #fff;
  border: 1px solid #e8e8e8;
  position: relative;
  overflow: hidden;
}

.dashboard-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  position: relative;
  z-index: 1;
}

.dashboard-title {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.title-text {
  font-size: 20px;
  font-weight: 700;
  color: #333;
}

.update-time {
  font-size: 12px;
  color: #666;
  font-weight: 400;
}

.dashboard-status {
  position: relative;
  z-index: 1;
}

.dashboard-content {
  display: flex;
  gap: 24px;
  position: relative;
  z-index: 1;
}

.system-status-section {
  flex: 0 0 auto;
}

.customer-stats-section {
  flex: 1;
}

.sse-card {
  background: #fff;
  border: 1px solid #e8e8e8;
  border-radius: 8px;
  padding: 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  min-width: 160px;
  transition: all 0.3s ease;
}

.sse-card:hover {
  border-color: #1890ff;
  transform: translateY(-2px);
}

.status-icon .icon {
  font-size: 24px;
  display: block;
  color: #1890ff;
}

.status-info {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.status-label {
  font-size: 12px;
  color: #666;
  font-weight: 500;
}

.status-value {
  font-size: 20px;
  color: #333;
  font-weight: 700;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 12px;
}

.stat-card {
  background: #fff;
  border: 1px solid #e8e8e8;
  border-radius: 8px;
  padding: 14px;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: all 0.3s ease;
  cursor: pointer;
}

.stat-card:hover {
  border-color: #1890ff;
  transform: translateY(-2px);
}

.primary-card {
  background: #1890ff;
  border: 1px solid #1890ff;
  color: white;
}

.primary-card:hover {
  background: #40a9ff;
  border-color: #40a9ff;
}

.primary-card .stat-label {
  color: rgba(255, 255, 255, 0.9);
}

.primary-card .stat-value {
  color: white;
}

.primary-card .stat-icon {
  color: white;
}

.stat-icon {
  font-size: 20px;
  flex-shrink: 0;
  color: #1890ff;
}

.stat-info {
  display: flex;
  flex-direction: column;
  gap: 2px;
  min-width: 0;
}

.stat-label {
  font-size: 11px;
  color: #666;
  font-weight: 500;
  line-height: 1.2;
}

.stat-value {
  font-size: 18px;
  color: #333;
  font-weight: 700;
}

.status-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  border-radius: 6px;
  background: #fff;
  border: 1px solid #e8e8e8;
  transition: all 0.3s ease;
}

.status-indicator:hover {
  border-color: #1890ff;
}

.indicator-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  display: inline-block;
  animation: pulse 2s infinite;
}

.status-indicator.online .indicator-dot {
  background-color: #52c41a;
}

.status-indicator.offline .indicator-dot {
  background-color: #ff4d4f;
}

.indicator-text {
  font-size: 12px;
  font-weight: 600;
  color: #333;
}

.dashboard-loading {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255, 255, 255, 0.9);
  border-radius: 8px;
  z-index: 2;
}

@keyframes pulse {
  0% {
    transform: scale(1);
    opacity: 1;
  }
  50% {
    transform: scale(1.1);
    opacity: 0.7;
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}

/* 移动端适配 */
@media (max-width: 768px) {
  .dashboard-header {
    flex-direction: column;
    gap: 12px;
    align-items: stretch;
    margin-bottom: 16px;
  }
  
  .dashboard-title {
    text-align: center;
  }
  
  .title-text {
    font-size: 18px;
  }
  
  .dashboard-status {
    align-self: center;
  }
  
  .dashboard-content {
    flex-direction: column;
    gap: 16px;
  }
  
  .sse-card {
    justify-content: center;
    min-width: auto;
  }
  
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
  }
  
  .stat-card {
    padding: 12px;
    flex-direction: column;
    text-align: center;
    gap: 6px;
  }
  
  .stat-info {
    align-items: center;
  }
  
  .stat-label {
    font-size: 10px;
    text-align: center;
  }
  
  .stat-value {
    font-size: 16px;
  }
}

/* 小屏幕优化 */
@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: 1fr;
  }
  
  .stat-card {
    flex-direction: row;
    justify-content: center;
    text-align: left;
  }
  
  .stat-info {
    align-items: flex-start;
  }
}

/* 桌面端大屏优化 */
@media (min-width: 1200px) {
  .dashboard-content {
    gap: 32px;
  }
  
  .stats-grid {
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
  }
  
  .sse-card {
    min-width: 180px;
    padding: 20px;
  }
  
  .stat-card {
    padding: 16px;
  }
}

/* 漏斗样式 - 简化配色 */
.funnel-container {
  background: #fff;
  border: 1px solid #e8e8e8;
  border-radius: 8px;
  padding: 16px;
  max-width: 600px;
  margin: 0 auto;
}

.funnel-title {
  text-align: center;
  font-size: 16px;
  font-weight: 600;
  color: #333;
  margin-bottom: 16px;
}

.funnel-steps {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 16px;
}

.funnel-step {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.step-content {
  background: #1890ff;
  border-radius: 6px;
  padding: 12px 20px;
  color: white;
  text-align: center;
  min-width: 280px;
  position: relative;
}

.step-1 .step-content {
  background: #1890ff;
  min-width: 320px;
}

.step-2 .step-content {
  background: #1890ff;
  min-width: 300px;
  opacity: 0.9;
}

.step-3 .step-content {
  background: #1890ff;
  min-width: 280px;
  opacity: 0.8;
}

.step-4 .step-content {
  background: #1890ff;
  min-width: 260px;
  opacity: 0.7;
}

.step-info {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.step-label {
  font-size: 13px;
  font-weight: 500;
  opacity: 0.9;
}

.step-value {
  font-size: 28px;
  font-weight: 700;
  line-height: 1;
}

.step-percentage {
  font-size: 16px;
  font-weight: 600;
  opacity: 0.8;
}

.funnel-arrow {
  width: 0;
  height: 0;
  border-left: 15px solid transparent;
  border-right: 15px solid transparent;
  border-top: 12px solid #ddd;
  margin: 4px 0;
}

.step-1 .funnel-arrow {
  border-top-color: #1890ff;
}

.step-2 .funnel-arrow {
  border-top-color: #1890ff;
  opacity: 0.9;
}

.step-3 .funnel-arrow {
  border-top-color: #1890ff;
  opacity: 0.8;
}

.conversion-summary {
  background: #f8f9fa;
  border-radius: 6px;
  padding: 12px;
  border: 1px solid #e8e8e8;
}

.summary-item {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
  font-size: 13px;
}

.summary-item:last-child {
  margin-bottom: 0;
}

.summary-label {
  color: #666;
  font-weight: 500;
}

.summary-value {
  font-size: 20px;
  font-weight: 700;
  color: #1890ff;
}

.summary-detail {
  color: #999;
  font-size: 12px;
}

/* 移动端适配 */
@media (max-width: 768px) {
  .funnel-container {
    padding: 12px;
    max-width: 100%;
  }
  
  .funnel-title {
    font-size: 14px;
    margin-bottom: 12px;
  }
  
  .step-content {
    padding: 10px 16px;
    min-width: 240px;
  }
  
  .step-1 .step-content {
    min-width: 260px;
  }
  
  .step-2 .step-content {
    min-width: 250px;
  }
  
  .step-3 .step-content {
    min-width: 240px;
  }
  
  .step-4 .step-content {
    min-width: 220px;
  }
  
  .step-label {
    font-size: 12px;
  }
  
  .step-value {
    font-size: 24px;
  }
  
  .step-percentage {
    font-size: 14px;
  }
  
  .summary-value {
    font-size: 18px;
  }
  
  .conversion-summary {
    padding: 10px;
  }
  
  .summary-item {
    font-size: 12px;
  }
  
  .summary-detail {
    font-size: 11px;
  }
}

/* 新增：未跑过任务未订阅用户模块样式 */
.inactive-users-module {
  margin-top: 8px;
  padding: 8px 12px;
  background: linear-gradient(135deg, #ff4d4f 0%, #ff7875 100%);
  border-radius: 6px;
  border: 1px solid #ff4d4f;
  box-shadow: 0 2px 4px rgba(255, 77, 79, 0.2);
}

.inactive-label {
  display: block;
  font-size: 12px;
  color: #fff;
  font-weight: 500;
  margin-bottom: 2px;
}

.inactive-value {
  display: inline-block;
  font-size: 16px;
  font-weight: 700;
  color: #fff;
  margin-right: 8px;
}

.inactive-percentage {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.9);
  font-weight: 500;
}

/* 移动端适配 */
@media (max-width: 768px) {
  .inactive-users-module {
    margin-top: 6px;
    padding: 6px 10px;
  }
  
  .inactive-label {
    font-size: 11px;
  }
  
  .inactive-value {
    font-size: 14px;
    margin-right: 6px;
  }
  
  .inactive-percentage {
    font-size: 11px;
  }
}
</style>